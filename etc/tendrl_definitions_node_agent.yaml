---
tendrl_schema_version: 0.2

namespace: tendrl.node_agent
  valid_objects:
  - Tendrl_context
  - Cpu
  - Network
  - Disk
  - Memory
  - Lvm
  - Iptable
  - User
  - Group
  - Node
  - Package
  - Service

  object_details:
    Tendrl_context:
      attrs:
        cluster_id:
          help: "Tendrl managed/generated cluster id for the sds being managed by Tendrl"
          type: String
        sds_name:
          help: "Name of the Tendrl managed sds, eg: 'gluster'"
          type: String
        sds_version:
          help: "Version of the Tendrl managed sds, eg: '3.2.1'"
          type: String
      enabled: true

    Cpu:
      enabled: True
      value: "/nodes/$node.id/cpu"
      attrs:
        model:
          type: String
        vendor_id:
          type: String
        model_name:
          type: String
        architecture:
          type: String
        cores_per_socket:
          type: String
        cpu_op_mode:
          type: String
        cpu_family:
          type: String
        cpu_count:
          type: String

    Memory:
      enabled: True
      value: "/nodes/$node.id/memory"
      attrs:
        total_size:
          type: String
        total_swap:
          type: String

    Node:
      enabled: True
      value: "/nodes/$node.id/node"
      attrs:
        fqdn:
          type: String
        cmd_str:
          type: String
      atoms:
        cmd:
          enabled: true
          inputs:
            mandatory:
              - Node.cmd_str
          name: "Execute CMD on Node"
          run: tendrl.node_agent.atoms.node.cmd.Cmd
          type: Create
          uuid: "dc8fff3a-34d9-4786-9282-55eff6abb6c3"


    OS:
      enabled: True
      value: "/nodes/$node.id/os"
      attrs:
        os:
          type: String
        os_varsion:
          type: String
        kernel_version:
          type: String
        selinux_mode:
          type: String

    Package:
      enabled: True
      attrs:
        name:
          help: "Location of the rpm/deb/pypi package"
          type: String
        version:
          help: "Version of the rpm/deb/pypi package"
          type: String
        pkg_type:
          help: "Type of package can be rpm/deb/pip/"
        state:
          help: "State can installed|uninstalled"
      atoms:
        install:
          enabled: true
          inputs:
            mandatory:
              - Package.name
              - Package.pkg_type
            optional:
              - Package.version
          name: "Install Package"
          post_run:
            - tendrl.node_agent.atoms.package.validations.check_package_installed
          run: tendrl.node_agent.atoms.package.install.Install
          type: Create
          uuid: "16abcfd0-aca9-4022-aa0f-5de1c5a742c7"
    Service:
      enabled: True
      attrs:
        name:
          help: "Name of the service"
          type: String
        state:
          help: "Service state can be started|stopped|restarted|reloaded"
          type: String
        config_path:
          help: "configuration file path for the service eg:/etc/tendrl/tendrl.conf"
          type: String
        config_data:
          help: "Configuration data for the service"
          type: String
      atoms:
        configure:
          enabled: true
          inputs:
            mandatory:
            - Service.config_path
            - Service.config_data
          name: "Configure Service"
          post_run:
            - tendrl.node_agent.atoms.service.validations.check_service_running
          run: tendrl.node_agent.atoms.service.configure.Configure
          type: Update
          uuid: "b90a0d97-8c9f-4ab1-8f64-dbb5638159a3"

    Process:
      enabled: True
      attrs:
        name:
          help: "Name of the service"
          type: String
        state:
          help: "Service state can be started|stopped|restarted|reloaded"
          type: String
      atoms:
        start:
          enabled: true
          inputs:
            mandatory:
            - Service.config_path
            - Service.config_data
          name: "Configure Service"
          post_run:
            - tendrl.node_agent.atoms.service.validations.check_service_running
          run: tendrl.node_agent.atoms.service.configure.Configure
          type: Update
          uuid: "b90a0d97-8c9f-4ab1-8f64-dbb5638159a3"


  flows:
    ImportGlusterCluster:
      uuid: "2f94a48a-05d7-408c-b400-e27827f4edef"
      description: "Import existing Gluster Cluster"
      atoms:
      - tendrl.node_agent.objects.Package.atoms.install
      - tendrl.node_agent.gluster_integration.objects.Config.atoms.generate
      - tendrl.node_agent.objects.File.atoms.write
      - tendrl.node_agent.objects.Node.atoms.cmd
      pre_run:
      - tendrl.node_agent.objects.Node.atoms.check_nodes_up
      - tendrl.node_agent.objects.Tendrl_context.atoms.compare
      post_run:
      - tendrl.node_agent.atoms.validations.check_sds_exists_in_tendrl
      run: "tendrl.node_agent.flows.import_gluster_cluster.ImportGlusterCluster"
      type: Create
      inputs:
        mandatory:
          - Node[]
          - Tendrl_context.sds_name
          - Tendrl_context.sds_version
      enabled: true
      version: 1


namespace: tendrl.node_agent.gluster_integration
  valid_objects:
   - Config
  object_details:
    Config:
      enabled: True
      attrs:
        file_path:
          help: "Path to the Gluster integration tendrl configuration"
          type: String
          default: "/etc/tendrl/gluster_integration.conf"
        etcd_port:
          help: "Port of the etcd central store for this Tendrl deployment"
          type: String
        etcd_connection:
          help: "Host/IP of the etcd central store for this Tendrl deployment"
          type: String
        data:
          help: "Configuration data of Gluster Integration for this Tendrl deployment"
          type: String
      atoms:
        generate:
          uuid: "807a1ead-bd70-4f55-99d0-dbd9d76d2a10"
          enabled: true
          name: "Generate Gluster Integration configuration based on provided inputs"
          inputs:
            mandatory:
              - Config.etcd_port
              - Config.etcd_connection
          outputs:
          - Config.data
          - Config.file_path
          run: tendrl.node_agent.gluster_integration.objects.Config.atoms.generate.Generate
